import Model from"./model.js";import showMessage from"./message.js";import randomSelection from"./utils.js";import tools from"./tools.js";function loadWidget(e){const t=new Model(e);localStorage.removeItem("waifu-display");sessionStorage.removeItem("waifu-text");document.body.insertAdjacentHTML("beforeend",`<div id="waifu">\n            <div id="waifu-tips"></div>\n            <canvas id="live2d" width="800" height="800"></canvas>\n            <div id="waifu-tool"></div>\n        </div>`);setTimeout((()=>{document.getElementById("waifu").style.bottom=0}),0);(function o(){tools["switch-model"].callback=()=>t.loadOtherModel();tools["switch-texture"].callback=()=>t.loadRandModel();if(!Array.isArray(e.tools)){e.tools=Object.keys(tools)}for(let t of e.tools){if(tools[t]){const{icon:e,callback:o}=tools[t];document.getElementById("waifu-tool").insertAdjacentHTML("beforeend",`<span id="waifu-tool-${t}">${e}</span>`);document.getElementById(`waifu-tool-${t}`).addEventListener("click",o)}}})();function o(e){if(location.pathname==="/"){for(let{hour:t,text:o}of e){const e=new Date,i=t.split("-")[0],s=t.split("-")[1]||i;if(i<=e.getHours()&&e.getHours()<=s){return o}}}const t=`欢迎阅读<span>「${document.title.split(" - ")[0]}」</span>`;let o;if(document.referrer!==""){const e=new URL(document.referrer),i=e.hostname.split(".")[1];const s={baidu:"百度",so:"360搜索",google:"谷歌搜索"};if(location.hostname===e.hostname)return t;if(i in s)o=s[i];else o=e.hostname;return`Hello！来自 <span>${o}</span> 的朋友<br>${t}`}return t}function i(e){let t=false,i,s=e.message.default,n;window.addEventListener("mousemove",(()=>t=true));window.addEventListener("keydown",(()=>t=true));setInterval((()=>{if(t){t=false;clearInterval(i);i=null}else if(!i){i=setInterval((()=>{showMessage(s,6e3,9)}),2e4)}}),1e3);showMessage(o(e.time),7e3,11);window.addEventListener("mouseover",(t=>{for(let{selector:o,text:i}of e.mouseover){if(!t.target.closest(o))continue;if(n===o)return;n=o;i=randomSelection(i);i=i.replace("{text}",t.target.innerText);showMessage(i,4e3,8);return}}));window.addEventListener("click",(t=>{for(let{selector:o,text:i}of e.click){if(!t.target.closest(o))continue;i=randomSelection(i);i=i.replace("{text}",t.target.innerText);showMessage(i,4e3,8);return}}));e.seasons.forEach((({date:e,text:t})=>{const o=new Date,i=e.split("-")[0],n=e.split("-")[1]||i;if(i.split("/")[0]<=o.getMonth()+1&&o.getMonth()+1<=n.split("/")[0]&&(i.split("/")[1]<=o.getDate()&&o.getDate()<=n.split("/")[1])){t=randomSelection(t);t=t.replace("{year}",o.getFullYear());s.push(t)}}));const a=()=>{};console.log("%c",a);a.toString=()=>{showMessage(e.message.console,6e3,9)};window.addEventListener("copy",(()=>{showMessage(e.message.copy,6e3,9)}));window.addEventListener("visibilitychange",(()=>{if(!document.hidden)showMessage(e.message.visibilitychange,6e3,9)}))}(function o(){let s=localStorage.getItem("modelId"),n=localStorage.getItem("modelTexturesId");if(s===null){s=1;n=53}t.loadModel(s,n);fetch(e.waifuPath).then((e=>e.json())).then(i)})()}function initWidget(e,t){if(typeof e==="string"){e={waifuPath:e,apiPath:t}}document.body.insertAdjacentHTML("beforeend",`<div id="waifu-toggle">\n            <span>看板娘</span>\n        </div>`);const o=document.getElementById("waifu-toggle");o.addEventListener("click",(()=>{o.classList.remove("waifu-toggle-active");if(o.getAttribute("first-time")){loadWidget(e);o.removeAttribute("first-time")}else{localStorage.removeItem("waifu-display");document.getElementById("waifu").style.display="";setTimeout((()=>{document.getElementById("waifu").style.bottom=0}),0)}}));if(localStorage.getItem("waifu-display")&&Date.now()-localStorage.getItem("waifu-display")<=864e5){o.setAttribute("first-time",true);setTimeout((()=>{o.classList.add("waifu-toggle-active")}),0)}else{loadWidget(e)}}export default initWidget;